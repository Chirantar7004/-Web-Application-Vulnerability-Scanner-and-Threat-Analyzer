<?php
$source=file_get_contents('member.php');
$tokens=token_get_all($source);

$accumulator=array();
$line_no_func=array();
$variablz=array();
$line_no_var=array();
$index_1=array();
$index_2=array();
$index_3=array();
$index_open=array();
$index_close=array();
$line_no_echo=array();
$find_out1=array();
$find_out2=array();
$find_out3=array();
$find_out4=array();
$find_out5=array();
$found_out1=array();
$found_out2=array();
$var_linked_final=array();
$func_linked_final=array();
$func_linked_final_no=array();
$user_defined=array();
$linked=array();
$linker_1=array();
$linker_2=array();
$linker_3=array();
$linker_4=array();
$linker_5=array();
$danger=array();
$a=0;
$b=0;
$c=0;
$d=0;
$e=0;
$f=0;
$g=0;
for($i=0,$z=count($tokens); $i<$z; $i++)
{
   if(is_array($tokens[$i]))
    {
	if($tokens[$i][0]==308)
	{
		$accumulator[$a]=$tokens[$i][1];
		$line_no_func[$a]=$tokens[$i][2];
		$index_1[$a]=$i;
		$a++;
	}
	if($tokens[$i][0]==310)
	{
		$variablz[$b]=$tokens[$i][1];
		$line_no_var[$b]=$tokens[$i][2];
		$index_2[$b]=$i;
		$b++;
	}
	if($tokens[$i][0]==317)
	{
		$line_no_echo[$c]=$tokens[$i][2];
		$index_3[$c]=$i;
		$c++;

	}
    }
    else
	{ 
		if($tokens[$i]=='(')
		{
			$index_open[$d]=$i;
			$d++;
		}
		else if($tokens[$i]==')')
		{
			$index_close[$e]=$i;
			$e++;	
			
		}
	}

 
}

echo "<br>";
echo "<br>";
echo "<br>";
$z=count($index_open);
$i=0;
$index=0;
while($index<$z)
{
	if($index_open[$index]<$index_2[$i] && $index_close[$index]>$index_2[$i])
	 {
		$find_out1[$f]=$index;
		$find_out2[$g]=$i;
		$i++;
		$index++;
		$f++;
		$g++;
	 }
	  else if($index_open[$index]>$index_2[$i])
	 {
		
		$i++;
	 }
	 else if($index_close[$index]<$index_2[$i])
	{
		$index++;
	}			
}
	
$s=0;

for($i=0,$z=count($find_out1);$i<$z;$i++)
{
	 $find_out3[$s]=$line_no_var[$find_out2[$i]];
	 	$s++;	
}	
for($i=0,$z=count($find_out1);$i<$z;$i++)
{
	echo $find_out1[$i];
	echo "<br>";
	
}

echo "<br>";
echo "<br>";
echo "<br>";
for($i=0,$z=count($line_no_func);$i<$z;$i++)
{
	echo $line_no_func[$i];
	echo "<br>";
	
}

$s=0;
$t=count($line_no_func);
$i=0;
$q=0;
while($i<$t)
{
	if($line_no_func[$i]==$find_out3[$s])
	{
		$find_out4[$q]=$i;
		$i++;
		$q++;
	}
	else if($line_no_func[$i]>$find_out3[$s])
	{
		$s++;
	}
	else
	{
		$i++;
	}

}
echo "<br>";
echo "<br>";
echo "<br>";
$s=0;
$t=0;
for($i=0,$z=count($find_out4);$i<$z;$i++)
{	
	$linker_1[$s]= $index_1[$find_out4[$i]];
		$s++;
	
}

echo "<br>";
echo "<br>";
echo "<br>";
for($i=0,$z=count($find_out1);$i<$z;$i++)
{
	$linker_2[$t]= $index_open[$find_out1[$i]];
	$t++;
	
}

echo "<br>";
echo "<br>";
for($i=0,$z=count($linker_2);$i<$z;$i++)
{
	echo $linker_2[$i];
	echo "<br>";
	
}
echo "<br>";
echo "<br>";
for($i=0,$z=count($linker_1);$i<$z;$i++)
{
	echo $linker_1[$i];
	echo "<br>";
	
}
$z=count($linker_1);
$r=count($linker_2);
$p=0;
$t=0;	
$i=0;
$j=0;
while($i<$z && $j<$r)
{
	if(($linker_1[$i]+1)==$linker_2[$j])
	{
		$linker_3[$p]=$linker_1[$i];
		$linker_4[$t]=$linker_2[$j];
		$p++;	
		$t++;
		$i++;
		$j++;
	}	
	else if($linker_1[$i]<$linker_2[$j])
	{
			$i++;
	}
	else if($linker_1[$i]>$linker_2[$j])
	{
			$j++;

	}


}
echo "<br>";
echo "<br>";
$t=0;
$s=0;
$i=0;
$z=count($linker_4);
$p=count($index_open);
while($i<$z)
{
	if($linker_4[$i]==$index_open[$s])
	{
		$find_out5[$t]=$s;
		$s++;
		$i++;
		$t++;
	}
	else
	{
		$s++;
	}
}
echo "<br>";
echo "<br>";
echo $find_out5[0];
echo "<br>";
echo "<br>";												
	
$t=0;		
$s=0;
$i=0;
$z=count($find_out5);
$p=count($find_out1);
while($i<$z)
{
	if($find_out5[$i]==$find_out1[$s])
	{
		$found_out1[$t]=$s;
		$s++;
		$i++;
		$t++;
	}
	else
	{
		$s++;
	}
}
$t=0;
$s=0;
$i=0;
$z=count($found_out1);
$p=count($find_out2);
while($i<$z)
{
	$found_out2[$t]=$find_out2[$found_out1[$i]];
	$t++;
	$i++;		
}

for($i=0,$z=count($linker_4);$i<$z;$i++)
{
	echo $linker_4[$i];
	echo "<br>";
	
}
echo "<br>";
echo "<br>";
for($i=0,$z=count($linker_3);$i<$z;$i++)
{
	echo $linker_3[$i];
	echo "<br>";
	
}
$t=0;
$s=0;
$i=0;
$z=count($found_out2);
while($i<$z)
{
	$var_linked_final[$t]=$tokens[$index_2[$found_out2[$i]]][1];
	$t++;
	$i++;		
}
print_r($var_linked_final);
$t=0;
$s=0;
$i=0;
$z=count($found_out2);
while($i<$z)
{
	$func_linked_final[$t]=$tokens[$linker_3[$i]][1];
	$func_linked_final_no[$t]=$tokens[$linker_3[$i]][2];
	$t++;
	$i++;		
}
print_r($func_linked_final);
$l=0;

for($i=0,$z=count($tokens); $i<$z; $i++)
{
   if(is_array($tokens[$i]))
    {
	if($tokens[$i][0]==310)
	{
		if($tokens[$i+1]=="=")
		{
			if(is_array($tokens[$i+2]))
			{
			 	if(($tokens[$i+2][1]=='$_GET')or($tokens[$i+2][1]=='$_POST'))
				{
					echo $l;
					$user_defined[$l]=$tokens[$i][1];
					$l++;
				}
			}
		}
	}
	
    }
}

		
echo "<br>";
echo "<br>";

print_r($user_defined);

$i=0;
$t=0;
$z=count($user_defined);
$p=count($var_linked_final);
$q=0;	
while($i<$z && $t<$p)
{

	if($user_defined[$i]==$var_linked_final[$t])
	{
		$danger[$q]=$t;
		$q++;
		$t++;
		$i++;
	}
	else if($i+1==$z)
	   { 
		$i=0;
		$t++;
	   } 
	     else
	   {
		$i++;
		
	   }
}



if(count($danger)!=0)
{
	echo "Vulnerability found out".PHP_EOL;
}
else
{
	echo "NO vulnerability";
}
$z=count($danger);
$i=0;
while($i<$z)
{


echo "Vulnerability present at line: ";
echo $func_linked_final_no[$danger[$i]].PHP_EOL;
echo "Vulnerability present in function: ";
echo $func_linked_final[$danger[$i]].PHP_EOL;
echo "Vulnerability presence due to variable: ";
echo $var_linked_final[$danger[$i]].PHP_EOL;
$i++;


}


?>
